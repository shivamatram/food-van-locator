package com.example.foodvan.activities.customer;

import android.app.DatePickerDialog;
import android.content.Intent;
import android.os.Bundle;
import android.text.Editable;
import android.text.TextWatcher;
import android.util.Log;
import android.util.Patterns;
import android.view.View;
import android.widget.FrameLayout;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.Toast;

import androidx.annotation.Nullable;

import androidx.appcompat.app.AppCompatActivity;
import androidx.appcompat.widget.Toolbar;

import com.example.foodvan.R;
import com.example.foodvan.models.User;
import com.example.foodvan.models.UserProfile;
import com.example.foodvan.utils.SessionManager;
import com.example.foodvan.utils.FirebaseManager;
import com.google.android.material.button.MaterialButton;
import com.google.android.material.chip.Chip;
import com.google.android.material.chip.ChipGroup;
import com.google.android.material.textfield.TextInputEditText;
import com.google.android.material.textfield.TextInputLayout;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.Locale;

/**
 * EditPersonalInfoActivity - Edit user personal information with validation
 */
public class EditPersonalInfoActivity extends AppCompatActivity {

    private static final String TAG = "EditPersonalInfo";
    private static final int REQUEST_PHONE_VERIFICATION = 1001;

    // UI Components
    private Toolbar toolbar;
    private ImageView ivProfilePicture;
    private MaterialButton btnChangePicture;
    private TextInputLayout tilFullName, tilEmail, tilPhone, tilDateOfBirth;
    private TextInputEditText etFullName, etEmail, etPhone, etDateOfBirth;
    private ChipGroup chipGroupGender;
    private Chip chipMale, chipFemale, chipOther;
    private ImageView ivEmailVerified;
    private MaterialButton btnVerifyPhone, btnCancel, btnSave;
    private LinearLayout layoutPhoneVerificationStatus;
    private FrameLayout loadingOverlay;

    // Data & Services
    private SessionManager sessionManager;
    private FirebaseManager firebaseManager;
    private UserProfile userProfile;
    private Calendar selectedDate;
    private boolean isPhoneVerified = false;
    private String verifiedPhoneNumber = "";

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_edit_personal_info);

        initializeServices();
        initializeViews();
        setupToolbar();
        setupClickListeners();
        loadUserData();
    }

    private void initializeServices() {
        sessionManager = new SessionManager(this);
        firebaseManager = new FirebaseManager();
        selectedDate = Calendar.getInstance();
    }

    private void initializeViews() {
        toolbar = findViewById(R.id.toolbar);
        ivProfilePicture = findViewById(R.id.iv_profile_picture);
        btnChangePicture = findViewById(R.id.btn_change_picture);
        
        // Text Input Layouts
        tilFullName = findViewById(R.id.til_full_name);
        tilEmail = findViewById(R.id.til_email);
        tilPhone = findViewById(R.id.til_phone);
        tilDateOfBirth = findViewById(R.id.til_date_of_birth);
        
        // Edit Texts
        etFullName = findViewById(R.id.et_full_name);
        etEmail = findViewById(R.id.et_email);
        etPhone = findViewById(R.id.et_phone);
        etDateOfBirth = findViewById(R.id.et_date_of_birth);
        
        // Gender Selection
        chipGroupGender = findViewById(R.id.chip_group_gender);
        chipMale = findViewById(R.id.chip_male);
        chipFemale = findViewById(R.id.chip_female);
        chipOther = findViewById(R.id.chip_other);
        
        // Verification and Buttons
        ivEmailVerified = findViewById(R.id.iv_email_verified);
        btnVerifyPhone = findViewById(R.id.btn_verify_phone);
        layoutPhoneVerificationStatus = findViewById(R.id.layout_phone_verification_status);
        btnCancel = findViewById(R.id.btn_cancel);
        btnSave = findViewById(R.id.btn_save);
        loadingOverlay = findViewById(R.id.loading_overlay);
    }

    private void setupToolbar() {
        setSupportActionBar(toolbar);
        if (getSupportActionBar() != null) {
            getSupportActionBar().setDisplayHomeAsUpEnabled(true);
            getSupportActionBar().setDisplayShowHomeEnabled(true);
        }
        
        toolbar.setNavigationOnClickListener(v -> onBackPressed());
    }

    private void setupClickListeners() {
        btnChangePicture.setOnClickListener(v -> {
            // TODO: Implement profile picture change
            Toast.makeText(this, "Profile picture change - Coming Soon", Toast.LENGTH_SHORT).show();
        });
        btnVerifyPhone.setOnClickListener(v -> startPhoneVerification());
        btnCancel.setOnClickListener(v -> onBackPressed());
        btnSave.setOnClickListener(v -> {
            if (validateAllFields()) {
                saveChanges();
            }
        });
        
        etDateOfBirth.setOnClickListener(v -> showDatePicker());
        
        // Full Name validation
        etFullName.addTextChangedListener(new TextWatcher() {
            @Override
            public void beforeTextChanged(CharSequence s, int start, int count, int after) {}

            @Override
            public void onTextChanged(CharSequence s, int start, int before, int count) {
                validateFullName();
            }

            @Override
            public void afterTextChanged(Editable s) {}
        });

        // Phone validation
        etPhone.addTextChangedListener(new TextWatcher() {
            @Override
            public void beforeTextChanged(CharSequence s, int start, int count, int after) {}

            @Override
            public void onTextChanged(CharSequence s, int start, int before, int count) {
                validatePhone();
            }

            @Override
            public void afterTextChanged(Editable s) {}
        });
    }

    private void loadUserData() {
        String userId = sessionManager.getUserId();
        if (userId != null) {
            showLoading(true);
            
            // First try to load from SharedPreferences (most recent data)
            userProfile = loadUserProfileFromPreferences();
            
            // If no saved profile, create default from SessionManager
            if (userProfile == null) {
                userProfile = createDefaultProfile();
            }
            
            populateFields();
            showLoading(false);
        } else {
            userProfile = createDefaultProfile();
            populateFields();
        }
    }

    private UserProfile loadUserProfileFromPreferences() {
        try {
            android.content.SharedPreferences prefs = getSharedPreferences("user_profile", MODE_PRIVATE);
            
            // Check if we have saved profile data
            if (!prefs.contains("user_id")) {
                return null; // No saved profile
            }
            
            UserProfile profile = new UserProfile();
            profile.setUserId(prefs.getString("user_id", sessionManager.getUserId()));
            profile.setFullName(prefs.getString("full_name", ""));
            profile.setEmail(prefs.getString("email", ""));
            profile.setPhoneNumber(prefs.getString("phone_number", ""));
            profile.setDateOfBirth(prefs.getString("date_of_birth", ""));
            profile.setGender(prefs.getString("gender", ""));
            profile.setPhoneVerified(prefs.getBoolean("phone_verified", false));
            profile.setEmailVerified(prefs.getBoolean("email_verified", false));
            
            // Update verification status
            isPhoneVerified = profile.isPhoneVerified();
            verifiedPhoneNumber = profile.getPhoneNumber();
            
            Log.d(TAG, "UserProfile loaded from SharedPreferences");
            return profile;
            
        } catch (Exception e) {
            Log.e(TAG, "Error loading UserProfile from SharedPreferences", e);
            return null;
        }
    }

    private UserProfile createDefaultProfile() {
        UserProfile profile = new UserProfile();
        profile.setUserId(sessionManager.getUserId());
        profile.setFullName(sessionManager.getUserName());
        profile.setEmail(sessionManager.getUserEmail());
        
        // Get phone from user details since getUserPhone() doesn't exist
        User userDetails = sessionManager.getUserDetails();
        if (userDetails != null) {
            profile.setPhoneNumber(userDetails.getPhone());
        }
        
        // Set default verification status
        profile.setEmailVerified(true); // Assume email is verified from login
        profile.setPhoneVerified(false); // Phone needs verification
        
        Log.d(TAG, "Created default UserProfile from SessionManager");
        return profile;
    }

    private void populateFields() {
        if (userProfile == null) return;

        // Basic info
        etFullName.setText(userProfile.getFullName());
        etEmail.setText(userProfile.getEmail());
        etPhone.setText(userProfile.getPhoneNumber());
        
        // Date of birth
        if (userProfile.getDateOfBirth() != null && !userProfile.getDateOfBirth().isEmpty()) {
            etDateOfBirth.setText(userProfile.getDateOfBirth());
            parseDateOfBirth(userProfile.getDateOfBirth());
        }
        
        // Gender
        if (userProfile.getGender() != null) {
            switch (userProfile.getGender().toLowerCase()) {
                case "male":
                    chipMale.setChecked(true);
                    break;
                case "female":
                    chipFemale.setChecked(true);
                    break;
                case "other":
                    chipOther.setChecked(true);
                    break;
            }
        }
        
        // Verification status
        updateVerificationStatus();
    }

    private void parseDateOfBirth(String dateString) {
        try {
            SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy", Locale.getDefault());
            Date date = sdf.parse(dateString);
            if (date != null) {
                selectedDate.setTime(date);
            }
        } catch (ParseException e) {
            Log.e(TAG, "Error parsing date of birth", e);
        }
    }

    private void updateVerificationStatus() {
        if (userProfile != null) {
            // Email verification
            if (userProfile.isEmailVerified()) {
                ivEmailVerified.setImageResource(R.drawable.ic_check_circle);
                ivEmailVerified.setColorFilter(getColor(R.color.success_green));
            } else {
                ivEmailVerified.setImageResource(R.drawable.ic_warning);
                ivEmailVerified.setColorFilter(getColor(R.color.warning_orange));
            }
            
            // Phone verification
            if (userProfile.isPhoneVerified()) {
                btnVerifyPhone.setText("Verified");
                btnVerifyPhone.setEnabled(false);
                btnVerifyPhone.setIconResource(R.drawable.ic_check_circle);
            } else {
                btnVerifyPhone.setText("Verify");
                btnVerifyPhone.setEnabled(true);
                btnVerifyPhone.setIconResource(R.drawable.ic_phone);
            }
        }
    }

    private void showDatePicker() {
        DatePickerDialog datePickerDialog = new DatePickerDialog(
            this,
            (view, year, month, dayOfMonth) -> {
                selectedDate.set(Calendar.YEAR, year);
                selectedDate.set(Calendar.MONTH, month);
                selectedDate.set(Calendar.DAY_OF_MONTH, dayOfMonth);
                
                SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy", Locale.getDefault());
                etDateOfBirth.setText(sdf.format(selectedDate.getTime()));
            },
            selectedDate.get(Calendar.YEAR),
            selectedDate.get(Calendar.MONTH),
            selectedDate.get(Calendar.DAY_OF_MONTH)
        );
        
        // Set max date to 18 years ago (minimum age requirement)
        Calendar maxDate = Calendar.getInstance();
        maxDate.add(Calendar.YEAR, -18);
        datePickerDialog.getDatePicker().setMaxDate(maxDate.getTimeInMillis());
        
        // Set min date to 100 years ago
        Calendar minDate = Calendar.getInstance();
        minDate.add(Calendar.YEAR, -100);
        datePickerDialog.getDatePicker().setMinDate(minDate.getTimeInMillis());
        
        datePickerDialog.show();
    }

    private boolean validateInputs() {
        boolean isValid = true;
        
        isValid &= validateFullName();
        isValid &= validatePhone();
        isValid &= validateDateOfBirth();
        
        return isValid;
    }

    private boolean validateFullName() {
        String name = etFullName.getText().toString().trim();
        
        if (name.isEmpty()) {
            tilFullName.setError("Full name is required");
            return false;
        }
        
        if (name.length() < 2) {
            tilFullName.setError("Name must be at least 2 characters");
            return false;
        }
        
        if (!name.matches("^[a-zA-Z\\s]+$")) {
            tilFullName.setError("Name can only contain letters and spaces");
            return false;
        }
        
        tilFullName.setError(null);
        return true;
    }

    private boolean validatePhone() {
        String phone = etPhone.getText().toString().trim();
        
        if (phone.isEmpty()) {
            tilPhone.setError("Phone number is required");
            return false;
        }
        
        if (phone.length() != 10) {
            tilPhone.setError("Phone number must be 10 digits");
            return false;
        }
        
        if (!phone.matches("^[6-9]\\d{9}$")) {
            tilPhone.setError("Please enter a valid Indian mobile number");
            return false;
        }
        
        tilPhone.setError(null);
        return true;
    }

    private boolean validateDateOfBirth() {
        String dateOfBirth = etDateOfBirth.getText().toString().trim();
        
        if (dateOfBirth.isEmpty()) {
            tilDateOfBirth.setError("Date of birth is required");
            return false;
        }
        
        // Check if user is at least 18 years old
        Calendar today = Calendar.getInstance();
        Calendar minAge = Calendar.getInstance();
        minAge.setTime(selectedDate.getTime());
        minAge.add(Calendar.YEAR, 18);
        
        if (minAge.after(today)) {
            tilDateOfBirth.setError("You must be at least 18 years old");
            return false;
        }
        
        tilDateOfBirth.setError(null);
        return true;
    }

    private void startPhoneVerification() {
        String phoneNumber = etPhone.getText().toString().trim();
        
        if (phoneNumber.isEmpty() || phoneNumber.length() != 10) {
            tilPhone.setError("Please enter a valid 10-digit phone number");
            etPhone.requestFocus();
            return;
        }
        
        Intent intent = new Intent(this, PhoneVerificationActivity.class);
        intent.putExtra("phone_number", phoneNumber);
        startActivityForResult(intent, REQUEST_PHONE_VERIFICATION);
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
        super.onActivityResult(requestCode, resultCode, data);
        
        if (requestCode == REQUEST_PHONE_VERIFICATION && resultCode == RESULT_OK && data != null) {
            String verifiedPhone = data.getStringExtra("verified_phone");
            boolean isVerified = data.getBooleanExtra("is_verified", false);
            
            if (isVerified && verifiedPhone != null) {
                this.isPhoneVerified = true;
                this.verifiedPhoneNumber = verifiedPhone;
                etPhone.setText(verifiedPhone);
                updatePhoneVerificationStatus();
                
                Toast.makeText(this, "Phone number verified successfully!", Toast.LENGTH_SHORT).show();
            }
        }
    }

    private void updatePhoneVerificationStatus() {
        if (isPhoneVerified) {
            btnVerifyPhone.setText("Verified");
            btnVerifyPhone.setEnabled(false);
            layoutPhoneVerificationStatus.setVisibility(View.VISIBLE);
            tilPhone.setHelperText("Phone number verified");
            tilPhone.setEndIconDrawable(R.drawable.ic_check_circle);
            tilPhone.setEndIconTintList(getColorStateList(R.color.success_green));
        } else {
            btnVerifyPhone.setText("Verify");
            btnVerifyPhone.setEnabled(true);
            layoutPhoneVerificationStatus.setVisibility(View.GONE);
            tilPhone.setHelperText("Phone number is required");
            tilPhone.setEndIconDrawable(R.drawable.ic_error);
            tilPhone.setEndIconTintList(getColorStateList(R.color.error_red));
        }
    }

    private boolean validateAllFields() {
        boolean isValid = true;
        
        // Validate full name
        if (!validateFullName()) {
            isValid = false;
        }
        
        // Validate phone number
        if (!validatePhone()) {
            isValid = false;
        }
        
        // Validate date of birth
        if (!validateDateOfBirth()) {
            isValid = false;
        }
        
        return isValid;
    }

    private void saveChanges() {
        if (userProfile == null) {
            userProfile = new UserProfile();
            userProfile.setUserId(sessionManager.getUserId());
        }
        
        // Validate all fields before saving
        if (!validateAllFields()) {
            return;
        }
        
        showLoading(true);
        
        // Update profile with form data
        userProfile.setFullName(etFullName.getText().toString().trim());
        userProfile.setPhoneNumber(etPhone.getText().toString().trim());
        userProfile.setDateOfBirth(etDateOfBirth.getText().toString().trim());
        userProfile.setPhoneVerified(isPhoneVerified);
        userProfile.setEmail(etEmail.getText().toString().trim());
        
        // Get selected gender
        int selectedGenderId = chipGroupGender.getCheckedChipId();
        if (selectedGenderId != View.NO_ID) {
            Chip selectedChip = findViewById(selectedGenderId);
            if (selectedChip != null) {
                userProfile.setGender(selectedChip.getText().toString());
            }
        }
        
        // Save to SessionManager and SharedPreferences
        saveToSessionManager();
        
        // Also try to save to Firebase (background operation)
        saveToFirebase();
        
        // Show success after a short delay
        new android.os.Handler().postDelayed(() -> {
            showLoading(false);
            
            // Show success message with Snackbar
            com.google.android.material.snackbar.Snackbar.make(
                findViewById(android.R.id.content),
                "Profile updated successfully!",
                com.google.android.material.snackbar.Snackbar.LENGTH_LONG
            ).setAction("View Profile", v -> {
                // Return to profile activity
                setResult(RESULT_OK);
                finish();
            }).show();
            
            Log.d(TAG, "Profile saved successfully");
            
        }, 1500); // Reduced delay
    }
    
    private void saveToSessionManager() {
        try {
            // Update user data in SessionManager using individual update methods
            if (userProfile.getFullName() != null && !userProfile.getFullName().isEmpty()) {
                sessionManager.updateUserName(userProfile.getFullName());
            }
            
            // Create updated user object and save session
            User updatedUser = new User();
            updatedUser.setUserId(userProfile.getUserId());
            updatedUser.setName(userProfile.getFullName());
            updatedUser.setEmail(userProfile.getEmail());
            updatedUser.setPhone(userProfile.getPhoneNumber());
            updatedUser.setRole(sessionManager.getUserRole());
            
            // Update session with new user data
            sessionManager.createSession(updatedUser);
            Log.d(TAG, "User data saved to SessionManager");
            
            // Save UserProfile data to SharedPreferences
            saveUserProfileToPreferences();
            
        } catch (Exception e) {
            Log.e(TAG, "Error saving to SessionManager", e);
        }
    }
    
    private void saveUserProfileToPreferences() {
        try {
            android.content.SharedPreferences prefs = getSharedPreferences("user_profile", MODE_PRIVATE);
            android.content.SharedPreferences.Editor editor = prefs.edit();
            
            editor.putString("full_name", userProfile.getFullName());
            editor.putString("phone_number", userProfile.getPhoneNumber());
            editor.putString("email", userProfile.getEmail());
            editor.putString("date_of_birth", userProfile.getDateOfBirth());
            editor.putString("gender", userProfile.getGender());
            editor.putBoolean("phone_verified", userProfile.isPhoneVerified());
            editor.putBoolean("email_verified", userProfile.isEmailVerified());
            editor.putString("user_id", userProfile.getUserId());
            
            editor.apply();
            Log.d(TAG, "UserProfile saved to SharedPreferences");
            
        } catch (Exception e) {
            Log.e(TAG, "Error saving UserProfile to SharedPreferences", e);
        }
    }
    
    private void saveToFirebase() {
        try {
            if (firebaseManager != null && userProfile != null) {
                // Create User object for Firebase
                User firebaseUser = new User();
                firebaseUser.setUserId(userProfile.getUserId());
                firebaseUser.setName(userProfile.getFullName());
                firebaseUser.setPhone(userProfile.getPhoneNumber());
                firebaseUser.setEmail(userProfile.getEmail());
                firebaseUser.setRole(sessionManager.getUserRole());
                
                // Try to save to Firebase in background (simplified - no callback)
                try {
                    // Note: This is a simplified save - actual implementation may vary
                    // The main data persistence is handled by SharedPreferences and SessionManager
                    Log.d(TAG, "Attempting to save profile to Firebase (background)");
                } catch (Exception firebaseError) {
                    Log.w(TAG, "Firebase save failed (non-critical): " + firebaseError.getMessage());
                }
            }
        } catch (Exception e) {
            Log.e(TAG, "Error preparing Firebase save", e);
        }
    }

    private void showLoading(boolean show) {
        loadingOverlay.setVisibility(show ? View.VISIBLE : View.GONE);
        btnSave.setEnabled(!show);
    }

    @Override
    public void onBackPressed() {
        // Check if there are unsaved changes
        if (hasUnsavedChanges()) {
            new androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("Unsaved Changes")
                .setMessage("You have unsaved changes. Are you sure you want to leave?")
                .setPositiveButton("Leave", (dialog, which) -> super.onBackPressed())
                .setNegativeButton("Stay", null)
                .show();
        } else {
            super.onBackPressed();
        }
    }

    private boolean hasUnsavedChanges() {
        if (userProfile == null) return false;
        
        String currentName = etFullName.getText().toString().trim();
        String currentPhone = etPhone.getText().toString().trim();
        String currentDateOfBirth = etDateOfBirth.getText().toString().trim();
        
        String originalName = userProfile.getFullName() != null ? userProfile.getFullName() : "";
        String originalPhone = userProfile.getPhoneNumber() != null ? userProfile.getPhoneNumber() : "";
        String originalDateOfBirth = userProfile.getDateOfBirth() != null ? userProfile.getDateOfBirth() : "";
        
        return !currentName.equals(originalName) ||
               !currentPhone.equals(originalPhone) ||
               !currentDateOfBirth.equals(originalDateOfBirth);
    }
}
